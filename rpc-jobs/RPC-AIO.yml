- job:
    name: RPC_AIO
    project-type: workflow
    concurrent: true
    parameters:
      # See params.yml
      - single_use_slave_params
      - rpc_params
      - string:
          name: STAGES
          default: "Allocate Resources, Connect Slave, Prepare Deployment, Cleanup"
          description: |
            Pipeline stages to run CSV. Note that this list does not influence execution order.
            Options:
              Allocate Resources
              Connect Slave
              Pause (use to hold instance for investigation before cleanup)
              Cleanup
    dsl: |
      // CIT Slave node
      node(){
        try {
          dir("rpc-gating"){
              git branch: env.RPC_GATING_BRANCH, url: env.RPC_GATING_REPO
              pubCloudSlave = load 'pipeline-steps/pubcloud.groovy'
              common = load 'pipeline-steps/common.groovy'
              aio_prepare = load 'pipeline-steps/aio_prepare.groovy'
          }
          instance_name = common.gen_instance_name()
          pubCloudSlave.getPubCloudSlave(instance_name: instance_name)
          node(instance_name){
            aio_prepare.prepare()
          } // pub cloud node
        } catch (Exception e){
          currentBuild.result = 'FAILURE'
          print e
        } finally {
          pubCloudSlave.delPubCloudSlave()
        }
      } // cit node
