- project:
    name: 'RPC-Artifact_Build-Jobs'
    defaults: global
    # Note: branch is the branch for periodics to build
    #       branches is the branch pattern to match for PR Jobs.
    series:
      - artifacts:
          branch: artifacts-14.0
          branches: "artifacts-.*"
    image:
      - trusty:
          IMAGE: "Ubuntu 14.04 LTS (Trusty Tahr) (PVHVM)"
    context:
      - Python
      - Container
      - Pipeline
    ztrigger:
      - pr:
          CRON: ""
          STAGES: "Allocate Resources, Connect Slave, Prepare Deployment, Build {context} Artifacts, Cleanup"
      - periodic:
          branches: "do_not_build_on_pr"
          STAGES: "Allocate Resources, Connect Slave, Prepare Deployment, Build Python Artifacts, Build Container Artifacts, Cleanup"
          PUSH_TO_MIRROR: yes
    exclude:
      - context: Python
        ztrigger: periodic
      - context: Container
        ztrigger: periodic
      - context: Pipeline
        ztrigger: pr
    jobs:
      - 'RPC-Artifact_Build-{series}-{image}-{context}-{ztrigger}'

- job-template:
    # DEFAULTS
    IMAGE: "Ubuntu 14.04 LTS (Trusty Tahr) (PVHVM)"
    DEPLOY_SWIFT: "yes"
    DEPLOY_CEPH: "yes"
    DEPLOY_ELK: "yes"
    CRON: "H H(9-21) * * 1-5"
    CONTEXT_USER_VARS: ""
    TRIGGER_USER_VARS: ""
    SERIES_USER_VARS: ""
    UPGRADE_FROM_REF: ""
    STAGES: "Allocate Resources, Connect Slave, Prepare Deployment, Build Python Artifacts, Build Container Artifacts, Cleanup"
    branch: artifacts-14.0
    PUSH_TO_MIRROR: "NO"

    # TEMPLATE
    name: 'RPC-Artifact_Build-{series}-{image}-{context}-{ztrigger}'
    project-type: workflow
    concurrent: false
    properties:
      - build-discarder:
          num-to-keep: 30
    parameters:
      # See params.yml
      - rpc_params:
         RPC_BRANCH: "{branch}"
         DEPLOY_SWIFT: "{DEPLOY_SWIFT}"
         DEPLOY_CEPH: "{DEPLOY_CEPH}"
         DEPLOY_ELK: "{DEPLOY_ELK}"
         USER_VARS: |
           {CONTEXT_USER_VARS}
           {SERIES_USER_VARS}
           {TRIGGER_USER_VARS}
         UPGRADE_FROM_REF: "{UPGRADE_FROM_REF}"
      - rpc_gating_params
      - single_use_slave_params:
         IMAGE: "{IMAGE}"
         FLAVOR: "performance2-15"
      - string:
          name: PUSH_TO_MIRROR
          default: "{PUSH_TO_MIRROR}"
          description: "Set this to YES if you want to push the newly built artifacts to rpc-repo."
      - string:
          name: STAGES
          default: "{STAGES}"
          description: |
            Pipeline stages to run CSV. Note that this list does not influence execution order.
            Options:
              Allocate Resources
              Connect Slave
              Prepare Deployment
              Build Python Artifacts
              Build Container Artifacts
              Pause (use to hold instance for investigation before cleanup)
              Cleanup
    triggers:
      - timed: "{CRON}"
    dsl: |
      // CIT Slave node
      node() {{
        dir("rpc-gating") {{
            git branch: env.RPC_GATING_BRANCH, url: env.RPC_GATING_REPO
            common = load 'pipeline-steps/common.groovy'
            pubcloud = load 'pipeline-steps/pubcloud.groovy'
            aio_prepare = load 'pipeline-steps/aio_prepare.groovy'
            artifact_build = load 'pipeline-steps/artifact_build.groovy'
        }}
        if (env.STAGES.contains("Build Python Artifacts")) {{
          pubcloud.runonpubcloud {{
            // try within pubcloud node so we can archive archive_artifacts
            // after a failure, before the node is cleaned up.
            try {{
              environment_vars = [
                "PUSH_TO_MIRROR=${{PUSH_TO_MIRROR}}",
              ]
              aio_prepare.prepare()
              artifact_build.python(environment_vars: environment_vars)
            }} catch (e) {{
              print(e)
              throw e
            }} finally {{
              common.archive_artifacts()
            }}
          }} // pubcloud slave
        }} // if
        if (env.STAGES.contains("Build Container Artifacts")) {{
          pubcloud.runonpubcloud {{
            // try within pubcloud node so we can archive archive_artifacts
            // after a failure, before the node is cleaned up.
            try {{
              environment_vars = [
                "PUSH_TO_MIRROR=${{PUSH_TO_MIRROR}}",
              ]
              aio_prepare.prepare()
              artifact_build.python(environment_vars: environment_vars)
            }} catch (e) {{
              print(e)
              throw e
            }} finally {{
              common.archive_artifacts()
            }}
          }} // pubcloud slave
        }} // if
      }} // cit node
